{% extends 'base.html' %}

{% block title %}Mistake Analysis - {{ quiz.title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-brain me-2"></i>{{ quiz.title }} - AI-Powered Mistake Analysis</h2>
    <div>
        <a href="{% url 'quiz_results' quiz.id %}" class="btn btn-secondary">
            <i class="fas fa-chart-bar me-1"></i>Back to Results
        </a>
        <a href="{% url 'teacher_dashboard' %}" class="btn btn-outline-secondary">
            <i class="fas fa-home me-1"></i>Dashboard
        </a>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title">Total Participants</h5>
                        <h3 class="mb-0">{{ participants.count }}</h3>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-users fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title">Students Need Help</h5>
                        <h3 class="mb-0">
                            {% with low_scorers=0 %}
                                {% for participant in participants %}
                                    {% if participant.score < 6 %}
                                        {% with low_scorers=low_scorers|add:1 %}{% endwith %}
                                    {% endif %}
                                {% endfor %}
                                {{ low_scorers }}
                            {% endwith %}
                        </h3>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- AI Analysis for Teachers -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-robot me-2"></i>AI Analysis for Teachers
                </h5>
                <form method="post" class="d-inline" onsubmit="showLoading(this)">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="generate_mistake_analysis">
                    <button type="submit" class="btn btn-light btn-sm" 
                            {% if not participants %}disabled{% endif %}
                            id="generateAnalysisBtn">
                        <i class="fas fa-magic me-1"></i>Generate Analysis
                    </button>
                </form>
            </div>
            <div class="card-body">
                {% if mistake_analysis %}
                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>AI-Generated Insights:</strong> This analysis was created by AI to help you understand student learning patterns.
                    </div>
                    
                    <div class="mistake-analysis-content">
                        {{ mistake_analysis|linebreaks }}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-brain fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Analysis Generated Yet</h5>
                        <p class="text-muted">Click "Generate Analysis" to get AI-powered insights about student mistakes and learning patterns.</p>
                        {% if not participants %}
                        <p class="text-warning">
                            <i class="fas fa-info-circle me-1"></i>
                            No participants have completed the quiz yet.
                        </p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- AI-Generated Student Help Content -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-graduation-cap me-2"></i>AI-Generated Student Help Content
                </h5>
                <form method="post" class="d-inline" onsubmit="showLoading(this)">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="generate_remedial_content">
                    <button type="submit" class="btn btn-light btn-sm"
                            {% if not mistake_analysis %}disabled{% endif %}
                            id="generateContentBtn">
                        <i class="fas fa-wand-magic-sparkles me-1"></i>Generate Content
                    </button>
                </form>
            </div>
            <div class="card-body">
                {% if remedial_content %}
                    <div class="alert alert-success">
                        <i class="fas fa-heart me-2"></i>
                        <strong>Student-Friendly Content:</strong> This content will help students understand their mistakes and improve their learning.
                    </div>
                    
                    <div class="remedial-content">
                        {{ remedial_content|linebreaks }}
                    </div>
                    
                    <hr>
                    
                    <div class="text-center">
                        <button class="btn btn-primary" onclick="shareWithStudents()">
                            <i class="fas fa-share-alt me-1"></i>Share with Students
                        </button>
                        <button class="btn btn-outline-secondary" onclick="copyContent()">
                            <i class="fas fa-copy me-1"></i>Copy Content
                        </button>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-graduation-cap fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Student Content Generated Yet</h5>
                        <p class="text-muted">Generate mistake analysis first, then create educational content to help students improve.</p>
                        {% if not mistake_analysis %}
                        <p class="text-info">
                            <i class="fas fa-arrow-up me-1"></i>
                            Generate the teacher analysis above first.
                        </p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Quick Stats -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Quick Stats</h6>
            </div>
            <div class="card-body">
                {% if participants %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="small">Average Score</span>
                            <span class="small">
                                {% with total_score=0 %}
                                    {% for p in participants %}
                                        {% with total_score=total_score|add:p.score %}{% endwith %}
                                    {% endfor %}
                                    {% widthratio total_score participants.count 1 %}/{{ quiz.questions.count }}
                                {% endwith %}
                            </span>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span class="small">Completion Rate</span>
                            <span class="small">100%</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="small">Total Questions</span>
                            <span class="small">{{ quiz.questions.count }}</span>
                        </div>
                    </div>
                {% endif %}
                
                <hr>
                
                <h6 class="small text-muted mb-2">AI Features</h6>
                <div class="list-group list-group-flush">
                    <div class="list-group-item d-flex justify-content-between align-items-center p-2">
                        <span class="small">
                            <i class="fas fa-robot me-1 text-primary"></i>Teacher Analysis
                        </span>
                        {% if mistake_analysis %}
                            <span class="badge bg-success">Ready</span>
                        {% else %}
                            <span class="badge bg-secondary">Pending</span>
                        {% endif %}
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center p-2">
                        <span class="small">
                            <i class="fas fa-graduation-cap me-1 text-success"></i>Student Content
                        </span>
                        {% if remedial_content %}
                            <span class="badge bg-success">Ready</span>
                        {% else %}
                            <span class="badge bg-secondary">Pending</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>How to Use</h6>
            </div>
            <div class="card-body">
                <div class="small">
                    <div class="mb-3">
                        <strong class="text-primary">Step 1:</strong> Generate AI analysis
                        <p class="text-muted mb-0">Get insights about student mistakes and learning patterns.</p>
                    </div>
                    <div class="mb-3">
                        <strong class="text-success">Step 2:</strong> Create student content
                        <p class="text-muted mb-0">Generate helpful learning materials based on the mistakes.</p>
                    </div>
                    <div>
                        <strong class="text-info">Step 3:</strong> Share with students
                        <p class="text-muted mb-0">Provide students with personalized learning content.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Share Content with Students</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>You can share this content with your students in several ways:</p>
                <ul>
                    <li><strong>Email:</strong> Copy the content and send via email</li>
                    <li><strong>LMS:</strong> Post in your learning management system</li>
                    <li><strong>Classroom:</strong> Display during next class session</li>
                    <li><strong>Study Groups:</strong> Share with student study groups</li>
                </ul>
                <div class="alert alert-info">
                    <i class="fas fa-lightbulb me-1"></i>
                    <strong>Tip:</strong> This content is personalized based on the specific mistakes your students made in this quiz.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="copyContent()">
                    <i class="fas fa-copy me-1"></i>Copy to Clipboard
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function shareWithStudents() {
    const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
    shareModal.show();
}

function copyContent() {
    const content = document.querySelector('.remedial-content').innerText;
    navigator.clipboard.writeText(content).then(function() {
        alert('Content copied to clipboard!');
    }).catch(function(err) {
        console.error('Could not copy text: ', err);
        // Fallback: select the text
        const range = document.createRange();
        range.selectNode(document.querySelector('.remedial-content'));
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
    });
}

function showLoading(form) {
    const button = form.querySelector('button[type="submit"]');
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating...';
    button.disabled = true;
    
    // Debug: Log form submission
    console.log('Form submitted:', form);
    console.log('Action:', form.querySelector('input[name="action"], button[name="action"]')?.value);
    
    // Re-enable after 30 seconds as safety
    setTimeout(function() {
        if (button.disabled) {
            button.innerHTML = originalText;
            button.disabled = false;
            console.log('Button re-enabled after timeout');
        }
    }, 30000);
    
    return true; // Allow form submission
}

// Auto-refresh indicators
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, checking for participants:', {{ participants.count }});
    
    // Debug: Check if forms are working
    const forms = document.querySelectorAll('form[method="post"]');
    console.log('Found', forms.length, 'POST forms');
    
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            console.log('Form submission detected:', this);
        });
    });
});
</script>
{% endblock %}
