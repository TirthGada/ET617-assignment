<!-- Trigger button -->
<button id="open-doubt-modal" style="margin-top:20px;">Ask a Doubt</button>

<!-- Modal -->
<div id="doubt-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6);">
  <div style="background:#fff; padding:20px; margin:100px auto; width:400px; border-radius:8px; position:relative;">
    <h3>Submit Your Doubt</h3>
    <form id="doubt-form">
  <input type="hidden" name="course" value="{{ content.course.id }}">
      <input type="hidden" name="content" value="{{ content.id }}">

      <label>Your Doubt:</label><br>
      <textarea name="text" rows="3" cols="40" required></textarea><br><br>

      <label>
        <input type="checkbox" name="anonymous" value="true">
        Ask anonymously
      </label><br><br>

      <button type="submit">Submit</button>
      <button type="button" id="close-doubt-modal">Cancel</button>
    </form>
    <p id="doubt-msg" style="color: green; display:none;">âœ… Doubt submitted successfully!</p>
  </div>
</div>

<script>
  const doubtModal = document.getElementById("doubt-modal");
  const openBtn = document.getElementById("open-doubt-modal");
  const closeBtn = document.getElementById("close-doubt-modal");

  openBtn.onclick = () => doubtModal.style.display = "block";
  closeBtn.onclick = () => doubtModal.style.display = "none";
  window.onclick = (e) => { if (e.target === doubtModal) doubtModal.style.display = "none"; };

  const csrftoken2 = (function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  })("csrftoken");

  document.getElementById("doubt-form").addEventListener("submit", function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = {};
    formData.forEach((value, key) => {
      if (key === "anonymous") {
        data[key] = true;
      } else {
        data[key] = value;
      }
    });

  fetch("/api/doubts/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken2
      },
      body: JSON.stringify(data)
    })
    .then(res => {
      if (!res.ok) throw new Error("Failed to submit doubt");
      return res.json();
    })
    .then(() => {
      document.getElementById("doubt-msg").style.display = "block";
      document.getElementById("doubt-form").reset();
      setTimeout(() => { doubtModal.style.display = "none"; }, 1000);
    })
    .catch(err => alert(err));
  });
</script>
